angular.module("afkl.lazyImage",[]),angular.module("afkl.lazyImage").service("afklSrcSetService",["$window","$timeout",function(a,b){"use strict";function c(a){this.src=a.src,this.w=a.w||1/0,this.h=a.h||1/0,this.x=a.x||1}function d(a,c){var d=!1;return function(){d||(a(),d=!0,b(function(){d=!1},c))}}var e=/^[0-9]+$/,f=function(a){for(var b=a.split(/\s/),c={},d=0,f=b.length;f>d;d++){var g=b[d];if(g.length>0){var h=g.slice(-1),i=g.substring(0,g.length-1),j=parseInt(i,10),k=parseFloat(i);i.match(e)&&"w"===h?c[h]=j:i.match(e)&&"h"===h?c[h]=j:isNaN(k)||"x"!==h||(c[h]=k)}}return c},g=function(a,b){for(var c=a[0],d=0,e=a.length;e>d;d++){var f=a[d];b(f,c)&&(c=f)}return c},h=function(a,b){for(var c=a.length-1;c>=0;c--){var d=a[c];b(d)&&a.splice(c,1)}return a},i=function(b,c){if(b){c||(c={w:a.innerWidth||document.documentElement.clientWidth,h:a.innerHeight||document.documentElement.clientHeight,x:a.devicePixelRatio||1});var d=b.slice(0),e=g(d,function(a,b){return a.w>b.w});h(d,function(){return function(a){return a.w<c.w}}(this)),0===d.length&&(d=[e]);var f=g(d,function(a,b){return a.h>b.h});h(d,function(){return function(a){return a.h<c.h}}(this)),0===d.length&&(d=[f]);var i=g(d,function(a,b){return a.x>b.x});h(d,function(){return function(a){return a.x<c.x}}(this)),0===d.length&&(d=[i]);var j=g(d,function(a,b){return a.w<b.w});h(d,function(a){return a.w>j.w});var k=g(d,function(a,b){return a.h<b.h});h(d,function(a){return a.h>k.h});var l=g(d,function(a,b){return a.x<b.x});return h(d,function(a){return a.x>l.x}),d[0]}},j=function(a){var b=[],d=a.src,e=a.srcset;if(e){var g=function(a){for(var c=0,d=b.length;d>c;c++){var e=b[c];if(e.x===a.x&&e.w===a.w&&e.h===a.h)return}b.push(a)},h=function(){for(var a,b,h=e,i=0,j=[];""!==h;){for(;" "===h.charAt(0);)h=h.slice(1);i=h.indexOf(" "),-1!==i?(a=h.slice(0,i),h=h.slice(i+1),i=h.indexOf(","),-1===i?(b=h,h=""):(b=h.slice(0,i),h=h.slice(i+1)),j.push({url:a,descriptors:b})):(j.push({url:h,descriptors:""}),h="")}for(var k=0,l=j.length;l>k;k++){var m=j[k],n=f(m.descriptors);g(new c({src:m.url,x:n.x,w:n.w,h:n.h}))}d&&g(new c({src:d}))};h();var j=i(b),k={best:j,candidates:b};return b=null,k}};return{get:j,image:i,debounce:d}}]),angular.module("afkl.lazyImage").directive("afklImageContainer",function(){"use strict";return{restrict:"A",controller:["$scope","$element",function(a,b){b.data("afklImageContainer",b)}]}}).directive("afklLazyImage",["$rootScope","$window","$timeout","afklSrcSetService","$parse",function(a,b,c,d,e){"use strict";var f=function(a){var b,c=d.get({srcset:a});return c&&(b=c.best.src),b};return{restrict:"A",link:function(d,g,h){var i=function(a){var b=[];return n.imgAttrs&&(b=Array.prototype.map.call(a,function(a){for(var b in a)if(a.hasOwnProperty(b))return String.prototype.concat.call(b,'="',a[b],'"')})),b.join(" ")},j=g.inheritedData("afklImageContainer");j||(j=angular.element(h.afklLazyImageContainer||b));var k,l=!1,m=h.afklLazyImage,n=h.afklLazyImageOptions?e(h.afklLazyImageOptions)(d):{},o=null,p=null,q=n.offset?n.offset:50,r=i(n.imgAttrs),s="afkl-lazy-image-loading";h.afklLazyImageLoaded=!1;var t=function(){if(j.scrollTop){var a=j.scrollTop();if(a)return a}var b=j[0];return void 0!==b.pageYOffset?b.pageYOffset:void 0!==b.scrollTop?b.scrollTop:document.documentElement.scrollTop||0},u=function(){if(j.innerHeight)return j.innerHeight();var a=j[0];return void 0!==a.innerHeight?a.innerHeight:void 0!==a.clientHeight?a.clientHeight:document.documentElement.clientHeight||0},v=function(){if(g.offset)return g.offset().top;var a=g[0].getBoundingClientRect();return a.top+t()-document.documentElement.clientTop},w=function(){return g.offset?g.offset().top-j.offset().top:g[0].getBoundingClientRect().top-j[0].getBoundingClientRect().top},x=function(){n.background?g[0].style.backgroundImage='url("'+p+'")':o&&(o[0].src=p)},y=function(){l=!0;var a=f(m);a&&(n.background||o||(g.addClass(s),o=angular.element("<img "+r+" />"),o.one("load",A),o.one("error",B),g.append(o)),z()),j.off("scroll",C)},z=function(){if(l){var a=f(m);a!==p&&(p=a,x())}};z();var A=function(){h.$set("afklLazyImageLoaded","done"),g.removeClass(s)},B=function(){h.$set("afklLazyImageLoaded","fail")},C=function(){if(!l){var a,c,d,e=u(),f=t(),g=j[0]===b?v():w();d=j[0]===b?e+f:e,a=g-d,c=q>=a,c&&y()}},D=C,E=function(){c.cancel(k),k=c(function(){z(),C()},300)},F=function(){c.cancel(k),angular.element(b).off("resize",E),angular.element(b).off("scroll",D),j[0]!==b&&(j.off("resize",E),j.off("scroll",D)),o&&o.remove(),o=k=p=void 0};return angular.element(b).on("resize",E),angular.element(b).on("scroll",D),j[0]!==b&&(j.on("resize",E),j.on("scroll",D)),h.$observe("afklLazyImage",function(){m=h.afklLazyImage,l&&y()}),n.nolazy&&y(),d.$on("afkl.lazyImage.destroyed",E),d.$on("$destroy",function(){return a.$broadcast("afkl.lazyImage.destroyed"),F()}),C()}}}]);